{% extends "base.html" %}
{% block content %}
<style>
  .expense-form-container {
    background: #ffffff;
    padding: 30px;
    border-radius: 12px;
    max-width: 600px;
    margin: 0 auto 40px;
    box-shadow: 0 10px 25px rgba(47, 133, 90, 0.15);
  }

  .expense-form-container h2 {
    text-align: center;
    color: #2f855a;
    font-weight: 700;
    margin-bottom: 25px;
    font-size: 2.2rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.08);
  }

  .expense-form-container label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 6px;
  }

  .form-control {
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }

  .form-control:focus {
    border-color: #38a169;
    box-shadow: 0 0 0 4px rgba(56, 161, 105, 0.2);
  }

  .alert {
    text-align: center;
    font-weight: 500;
  }

  button[type="submit"] {
    background-color: #2f855a;
    border: none;
    padding: 12px 30px;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 30px;
    margin-top: 15px;
    width: 100%;
    transition: all 0.3s ease;
    box-shadow: 0 6px 16px rgba(47, 133, 90, 0.3);
  }

  button[type="submit"]:hover {
    background-color: #276749;
    box-shadow: 0 8px 20px rgba(39, 103, 73, 0.4);
  }
</style>

<div class="expense-form-container">
  <h2>Add Expense</h2>

  {% if msg %}
    <div class="alert alert-warning">{{ msg }}</div>
  {% endif %}
<form method="post">
  <div class="mb-3">
    <label>Start Date</label>
    <input type="date" id="start-date" name="start_date" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>End Date</label>
    <input type="date" id="end-date" name="end_date" class="form-control" required>
  </div>

    <button type="button" id="load-cats" class="btn btn-secondary mb-3">
    Load Categories
  </button>

  <div id="category-container" style="display: none;">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Category</th>
          <th>Amount</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody id="category-table-body">
        <!-- JS will inject one <tr> per category -->
      </tbody>
    </table>
  </div>

  <button type="submit" class="btn btn-primary">Add Expense</button>
</form>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const startEl   = document.getElementById('start-date');
  const endEl     = document.getElementById('end-date');
  const loadBtn   = document.getElementById('load-cats');
  const container = document.getElementById('category-container');
  const tbody     = document.getElementById('category-table-body');

  function isFullDate(s) {
    return /^\d{4}-\d{2}-\d{2}$/.test(s);
  }

  loadBtn.addEventListener('click', () => {
    const sd = startEl.value, ed = endEl.value;
    if (!isFullDate(sd) || !isFullDate(ed)) {
      return; // wait until both dates are valid
    }

    fetch('/get-categories', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ start_date: sd, end_date: ed })
    })
    .then(r => r.json())
    .then(data => {
      // If no budget or categories, notify user
      if (!data.success || data.categories.length === 0) {
        alert('No budget set up for these dates.');
        tbody.innerHTML = '';
        container.style.display = 'none';
        return;
      }

      // Populate table rows
      tbody.innerHTML = '';
      data.categories.forEach(cat => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            ${cat.name}
            <input type="hidden" name="category_ids" value="${cat.id}">
          </td>
          <td>
            <input type="number"
                   name="amount_${cat.id}"
                   class="form-control"
                   step="0.01"
                   placeholder="Amount">
          </td>
          <td>
            <input type="text"
                   name="note_${cat.id}"
                   class="form-control"
                   placeholder="Note (optional)">
          </td>`;
        tbody.appendChild(tr);
      });

      // Show the table container
      container.style.display = 'block';
    })
    .catch(err => {
      console.error('Fetch error:', err);
      tbody.innerHTML = '';
      container.style.display = 'none';
    });
  });
});
</script>


{% endblock %}
